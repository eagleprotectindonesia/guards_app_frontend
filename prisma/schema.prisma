generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  superadmin
  admin
}

model Admin {
  id                 String    @id @default(uuid())
  name               String
  email              String    @unique
  hashedPassword     String    @map("hashed_password")
  role               AdminRole @default(admin)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  acknowledgedAlerts Alert[]   @relation("AcknowledgedBy")
  resolvedAlerts     Alert[]   @relation("ResolvedBy")

  @@map("admins")
}

model Guard {
  id             String    @id @default(uuid())
  name           String
  phone          String    @unique
  hashedPassword String    @map("hashed_password") // Added password field
  tokenVersion   Int       @default(0) @map("token_version")
  guardCode      String?   @map("guard_code") @db.VarChar(10)
  status         Boolean?  @default(true)
  joinDate       DateTime? @map("join_date")
  leftDate       DateTime? @map("left_date")
  note           String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  checkins       Checkin[]
  shifts         Shift[]

  @@map("guards")
}

model Site {
  id         String   @id @default(uuid())
  name       String
  clientName String?  @map("client_name")
  address    String?
  latitude   Float?
  longitude  Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  alerts     Alert[]
  shifts     Shift[]

  @@map("sites")
}

model ShiftType {
  id        String   @id @default(uuid())
  name      String
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shifts    Shift[]

  @@map("shift_types")
}

model Shift {
  id                          String         @id @default(uuid())
  siteId                      String         @map("site_id")
  shiftTypeId                 String         @map("shift_type_id")
  guardId                     String?        @map("guard_id")
  date                        DateTime       @db.Date
  startsAt                    DateTime       @map("starts_at")
  endsAt                      DateTime       @map("ends_at")
  status                      ShiftStatus    @default(scheduled)
  checkInStatus               CheckInStatus? @map("check_in_status")
  requiredCheckinIntervalMins Int            @default(20) @map("required_checkin_interval_minutes")
  graceMinutes                Int            @default(2) @map("grace_minutes")
  lastHeartbeatAt             DateTime?      @map("last_heartbeat_at") @db.Timestamptz(6)
  missedCount                 Int            @default(0) @map("missed_count")
  createdBy                   String?        @map("created_by")
  createdAt                   DateTime       @default(now()) @map("created_at")
  updatedAt                   DateTime       @updatedAt
  alerts                      Alert[]
  checkins                    Checkin[]
  guard                       Guard?         @relation(fields: [guardId], references: [id])
  shiftType                   ShiftType      @relation(fields: [shiftTypeId], references: [id])
  site                        Site           @relation(fields: [siteId], references: [id])
  attendance                  Attendance?

  @@index([siteId, date])
  @@index([guardId, date])
  @@index([guardId, startsAt])
  @@index([startsAt, endsAt])
  @@map("shifts")
}

model Checkin {
  id        String        @id @default(uuid())
  shiftId   String        @map("shift_id")
  guardId   String        @map("guard_id")
  at        DateTime      @default(now()) @db.Timestamptz(6)
  source    String?
  status    CheckInStatus
  metadata  Json?
  createdAt DateTime      @default(now()) @map("created_at")
  guard     Guard         @relation(fields: [guardId], references: [id])
  shift     Shift         @relation(fields: [shiftId], references: [id])

  @@unique([shiftId, at])
  @@map("checkins")
}

model Alert {
  id               String           @id @default(uuid())
  shiftId          String           @map("shift_id")
  siteId           String           @map("site_id")
  reason           AlertReason
  severity         AlertSeverity
  windowStart      DateTime         @map("window_start") @db.Timestamptz(6)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  acknowledgedAt   DateTime?        @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedById String?          @map("acknowledged_by_id")
  resolvedAt       DateTime?        @map("resolved_at") @db.Timestamptz(6)
  resolvedById     String?          @map("resolved_by_id")
  resolutionNote   String?          @map("resolution_note")
  resolutionType   AlertResolution? @map("resolution_type")
  ackAdmin         Admin?           @relation("AcknowledgedBy", fields: [acknowledgedById], references: [id])
  resolverAdmin    Admin?           @relation("ResolvedBy", fields: [resolvedById], references: [id])
  shift            Shift            @relation(fields: [shiftId], references: [id])
  site             Site             @relation(fields: [siteId], references: [id])

  @@unique([shiftId, reason, windowStart])
  @@index([siteId, createdAt])
  @@map("alerts")
}

enum ShiftStatus {
  scheduled
  in_progress
  completed
  missed
}

enum CheckInStatus {
  on_time
  late
  invalid
}

enum AlertReason {
  missed_checkin
  missed_attendance
}

enum AlertSeverity {
  warning
  critical
}

enum AlertResolution {
  standard
  forgiven
  auto
}

model Attendance {
  id         String           @id @default(uuid())
  shiftId    String           @map("shift_id")
  recordedAt DateTime         @default(now()) @map("recorded_at") @db.Timestamptz(6)
  picture    String? // URL or path to the attendance picture
  status     AttendanceStatus
  metadata   Json? // Additional information like geolocation, device info
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt

  shift Shift @relation(fields: [shiftId], references: [id])

  @@unique([shiftId]) // Ensuring one attendance record per shift
  @@map("attendance")
}

enum AttendanceStatus {
  present
  absent
  late
  pending_verification
}
