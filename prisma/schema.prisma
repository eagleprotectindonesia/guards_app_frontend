generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AdminRole {
  superadmin
  admin
}

model Admin {
  id                 String      @id @default(uuid())
  name               String
  email              String      @unique
  hashedPassword     String      @map("hashed_password")
  role               AdminRole   @default(admin)
  tokenVersion       Int         @default(0) @map("token_version")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  deletedAt          DateTime?   @map("deleted_at")
  note               String?     @db.Text
  acknowledgedAlerts Alert[]     @relation("AcknowledgedBy")
  resolvedAlerts     Alert[]     @relation("ResolvedBy")
  updatedGuards      Guard[]     @relation("GuardLastUpdatedBy")
  updatedSites       Site[]      @relation("SiteLastUpdatedBy")
  updatedShiftTypes  ShiftType[] @relation("ShiftTypeLastUpdatedBy")
  updatedShifts      Shift[]     @relation("ShiftLastUpdatedBy")
  createdGuards      Guard[]     @relation("GuardCreatedBy")
  createdSites       Site[]      @relation("SiteCreatedBy")
  createdShiftTypes  ShiftType[] @relation("ShiftTypeCreatedBy")
  createdShifts      Shift[]     @relation("ShiftCreatedBy")
  changelogs         Changelog[]

  @@index([deletedAt])
  @@map("admins")
}

model Changelog {
  id         String   @id @default(uuid())
  action     String // CREATE, UPDATE, DELETE, BULK_CREATE
  entityType String   @map("entity_type") // e.g., "Guard", "Site"
  entityId   String   @map("entity_id")
  details    Json? // Store changed fields or snapshot
  adminId    String?  @map("admin_id")
  createdAt  DateTime @default(now()) @map("created_at")

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([entityType, entityId])
  @@index([entityType, createdAt])
  @@index([createdAt])
  @@map("changelogs")
}

model Guard {
  id              String       @id
  name            String
  phone           String       @unique
  hashedPassword  String       @map("hashed_password") // Added password field
  tokenVersion    Int          @default(0) @map("token_version")
  guardCode       String?      @map("guard_code") @db.VarChar(10)
  status          Boolean?     @default(true)
  joinDate        DateTime?    @map("join_date") @db.Date
  leftDate        DateTime?    @map("left_date") @db.Date
  note            String?      @db.Text
  lastUpdatedById String?      @map("last_updated_by_id")
  createdById     String?      @map("created_by_id")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?    @map("deleted_at")
  checkins        Checkin[]
  shifts          Shift[]
  attendances     Attendance[]
  lastUpdatedBy   Admin?       @relation("GuardLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?       @relation("GuardCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([deletedAt])
  @@index([guardCode])
  @@map("guards")
}

model Site {
  id              String    @id @default(uuid())
  name            String
  clientName      String?   @map("client_name")
  address         String?
  latitude        Float?
  longitude       Float?
  status          Boolean?  @default(true)
  lastUpdatedById String?   @map("last_updated_by_id")
  createdById     String?   @map("created_by_id")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")
  note            String?   @db.Text
  alerts          Alert[]
  shifts          Shift[]
  lastUpdatedBy   Admin?    @relation("SiteLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?    @relation("SiteCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([deletedAt])
  @@map("sites")
}

model ShiftType {
  id              String    @id @default(uuid())
  name            String
  startTime       String    @map("start_time")
  endTime         String    @map("end_time")
  lastUpdatedById String?   @map("last_updated_by_id")
  createdById     String?   @map("created_by_id")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")
  shifts          Shift[]
  lastUpdatedBy   Admin?    @relation("ShiftTypeLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?    @relation("ShiftTypeCreatedBy", fields: [createdById], references: [id])

  @@index([deletedAt])
  @@map("shift_types")
}

model Shift {
  id                          String         @id @default(uuid())
  siteId                      String         @map("site_id")
  shiftTypeId                 String         @map("shift_type_id")
  guardId                     String?        @map("guard_id")
  date                        DateTime       @db.Date
  startsAt                    DateTime       @map("starts_at")
  endsAt                      DateTime       @map("ends_at")
  status                      ShiftStatus    @default(scheduled)
  checkInStatus               CheckInStatus? @map("check_in_status")
  requiredCheckinIntervalMins Int            @default(20) @map("required_checkin_interval_minutes")
  graceMinutes                Int            @default(2) @map("grace_minutes")
  lastHeartbeatAt             DateTime?      @map("last_heartbeat_at") @db.Timestamptz(6)
  missedCount                 Int            @default(0) @map("missed_count")
  createdById                 String?        @map("created_by_id")
  lastUpdatedById             String?        @map("last_updated_by_id")
  createdAt                   DateTime       @default(now()) @map("created_at")
  updatedAt                   DateTime       @updatedAt
  deletedAt                   DateTime?      @map("deleted_at")
  note                        String?        @db.Text
  alerts                      Alert[]
  checkins                    Checkin[]
  guard                       Guard?         @relation(fields: [guardId], references: [id])
  shiftType                   ShiftType      @relation(fields: [shiftTypeId], references: [id])
  site                        Site           @relation(fields: [siteId], references: [id])
  createdBy                   Admin?         @relation("ShiftCreatedBy", fields: [createdById], references: [id])
  lastUpdatedBy               Admin?         @relation("ShiftLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  attendance                  Attendance?

  @@index([siteId, date])
  @@index([guardId, date])
  @@index([guardId, startsAt])
  @@index([startsAt, endsAt])
  @@index([guardId, status, startsAt]) // For active shift queries
  @@index([guardId, status, endsAt]) // For active shift queries with endsAt
  @@index([guardId, status, date, startsAt]) // For next shifts queries
  @@index([deletedAt])
  @@map("shifts")
}

model Checkin {
  id        String        @id @default(uuid())
  shiftId   String        @map("shift_id")
  guardId   String        @map("guard_id")
  at        DateTime      @default(now()) @db.Timestamptz(6)
  source    String?
  status    CheckInStatus
  metadata  Json?
  createdAt DateTime      @default(now()) @map("created_at")
  guard     Guard         @relation(fields: [guardId], references: [id])
  shift     Shift         @relation(fields: [shiftId], references: [id])

  @@unique([shiftId, at])
  @@index([createdAt])
  @@map("checkins")
}

model Alert {
  id               String           @id @default(uuid())
  shiftId          String           @map("shift_id")
  siteId           String           @map("site_id")
  reason           AlertReason
  severity         AlertSeverity
  windowStart      DateTime         @map("window_start") @db.Timestamptz(6)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  acknowledgedAt   DateTime?        @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedById String?          @map("acknowledged_by_id")
  resolvedAt       DateTime?        @map("resolved_at") @db.Timestamptz(6)
  resolvedById     String?          @map("resolved_by_id")
  resolutionNote   String?          @map("resolution_note")
  resolutionType   AlertResolution? @map("resolution_type")
  ackAdmin         Admin?           @relation("AcknowledgedBy", fields: [acknowledgedById], references: [id])
  resolverAdmin    Admin?           @relation("ResolvedBy", fields: [resolvedById], references: [id])
  shift            Shift            @relation(fields: [shiftId], references: [id])
  site             Site             @relation(fields: [siteId], references: [id])

  @@unique([shiftId, reason, windowStart])
  @@index([siteId, createdAt])
  @@index([reason])
  @@map("alerts")
}

enum ShiftStatus {
  scheduled
  in_progress
  completed
  missed
  cancelled
}

enum CheckInStatus {
  on_time
  late
  invalid
}

enum AlertReason {
  missed_checkin
  missed_attendance
}

enum AlertSeverity {
  warning
  critical
}

enum AlertResolution {
  standard
  forgiven
  auto
}

model Attendance {
  id         String           @id @default(uuid())
  shiftId    String           @map("shift_id")
  guardId    String?          @map("guard_id") // Add guardId for direct filtering
  recordedAt DateTime         @default(now()) @map("recorded_at") @db.Timestamptz(6)
  picture    String?
  status     AttendanceStatus
  metadata   Json?
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt

  shift Shift  @relation(fields: [shiftId], references: [id])
  guard Guard? @relation(fields: [guardId], references: [id])

  @@unique([shiftId]) // Ensuring one attendance record per shift
  @@index([recordedAt]) // For attendance export queries
  @@index([guardId]) // For direct guard filtering in attendance export
  @@index([shiftId]) // For joining with shifts table
  @@map("attendance")
}

model SystemSetting {
  name  String @id
  value String
  note  String?

  @@map("system_settings")
}

enum AttendanceStatus {
  present
  absent
  late
  pending_verification
}
