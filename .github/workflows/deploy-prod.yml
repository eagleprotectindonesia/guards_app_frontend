name: Deploy to Production (EC2)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}

            echo "== Pull latest code =="
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github_actions_deploy -o StrictHostKeyChecking=accept-new"
            git fetch --all
            git reset --hard origin/main

            echo "== Inject Build ID =="
            export BUILD_ID=$(git rev-parse --short HEAD)
            sed -i "s/{{BUILD_ID}}/$BUILD_ID/g" public/guard/sw.js

            echo "== Build new images =="
            docker-compose build

            echo "== Run DB migrations =="
            # Run migration in a temporary container (using new image) BEFORE restarting app
            docker-compose run --rm app npx prisma migrate deploy

            echo "== Update containers =="
            # Recreates only changed containers with minimal downtime
            docker-compose up -d

            echo "== Status =="
            docker-compose ps
