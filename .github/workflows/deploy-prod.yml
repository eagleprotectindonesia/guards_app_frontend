name: Deploy to Production (EC2)

on:
  push:
    # 1. Update this to include any branch you want to deploy
    branches: ["main", "dev-tian-backup"] 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # 2. Pass the branch name as an environment variable to the script
          envs: GITHUB_REF_NAME 
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}

            echo "== Pull latest code from $GITHUB_REF_NAME =="
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github_actions_deploy -o StrictHostKeyChecking=accept-new"
            git fetch --all
            # 3. Use the variable here so it resets to the correct branch
            git reset --hard origin/$GITHUB_REF_NAME

            echo "== Rebuild & restart containers =="
            docker-compose up -d --build

            echo "== Run DB migrations =="
            docker-compose exec -T app npx prisma migrate deploy