generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  supervisor
  guard
}

enum ShiftStatus {
  assigned
  unassigned
  canceled
}

enum CheckInStatus {
  on_time
  late
  invalid
}

enum AlertReason {
  missed_checkin
}

enum AlertSeverity {
  warning
  critical
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  role      Role
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shifts             Shift[]
  checkins           Checkin[]
  acknowledgedAlerts Alert[]   @relation("AcknowledgedBy")
  resolvedAlerts     Alert[]   @relation("ResolvedBy")

  @@map("users")
}

model Site {
  id        String   @id @default(uuid())
  name      String
  timeZone  String   @map("time_zone") // IANA time zone string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts  Post[]
  alerts Alert[]

  @@map("sites")
}

model Post {
  id                String   @id @default(uuid())
  siteId            String   @map("site_id")
  name              String
  requiredHeadcount Int      @default(1) @map("required_headcount")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  site   Site    @relation(fields: [siteId], references: [id])
  shifts Shift[]

  @@map("posts")
}

model Shift {
  id                          String      @id @default(uuid())
  postId                      String      @map("post_id")
  userId                      String?     @map("user_id")
  startsAt                    DateTime    @map("starts_at") @db.Timestamptz
  endsAt                      DateTime    @map("ends_at") @db.Timestamptz
  status                      ShiftStatus @default(unassigned)
  requiredCheckinIntervalMins Int         @default(60) @map("required_checkin_interval_minutes")
  graceMinutes                Int         @default(15) @map("grace_minutes")
  lastHeartbeatAt             DateTime?   @map("last_heartbeat_at") @db.Timestamptz
  missedCount                 Int         @default(0) @map("missed_count")
  createdBy                   String?     @map("created_by")
  createdAt                   DateTime    @default(now()) @map("created_at")
  updatedAt                   DateTime    @updatedAt

  post     Post      @relation(fields: [postId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])
  checkins Checkin[]
  alerts   Alert[]

  // Indexes for querying
  @@index([postId, startsAt])
  @@index([userId, startsAt])
  @@index([startsAt])
  @@index([endsAt])
  @@map("shifts")
}

model Checkin {
  id        String        @id @default(uuid())
  shiftId   String        @map("shift_id")
  userId    String        @map("user_id")
  at        DateTime      @default(now()) @db.Timestamptz
  source    String? // e.g., "web", "sms"
  status    CheckInStatus
  metadata  Json?
  createdAt DateTime      @default(now()) @map("created_at")

  shift Shift @relation(fields: [shiftId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([shiftId, at]) // Or just index depending on granularity, but unique helps dedupe exact timestamp spam
  @@map("checkins")
}

model Alert {
  id             String        @id @default(uuid())
  shiftId        String        @map("shift_id")
  siteId         String        @map("site_id")
  reason         AlertReason
  severity       AlertSeverity
  windowStart    DateTime      @map("window_start") @db.Timestamptz
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz
  acknowledgedAt DateTime?     @map("acknowledged_at") @db.Timestamptz
  acknowledgedBy String?       @map("acknowledged_by")
  resolvedAt     DateTime?     @map("resolved_at") @db.Timestamptz
  resolvedBy     String?       @map("resolved_by")

  shift        Shift @relation(fields: [shiftId], references: [id])
  site         Site  @relation(fields: [siteId], references: [id])
  resolverUser User? @relation("ResolvedBy", fields: [resolvedBy], references: [id])
  ackUser      User? @relation("AcknowledgedBy", fields: [acknowledgedBy], references: [id])

  @@unique([shiftId, reason, windowStart])
  @@index([siteId, createdAt])
  @@map("alerts")
}